<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JSON Pretty Formatter</title>

<link rel="stylesheet" href="../../assets/css/header.css">

<style>
body {
    font-family: "Segoe UI", system-ui;
    background: #f8fafc;
    padding: 4px;
    color: #1f2937;
}

h2 {
    margin-bottom: 10px;
}

.toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.toolbar-left {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.toolbar-right {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.toolbar-error {
    margin-left: auto;
    white-space: nowrap;
    font-size: 14px;
}


button {
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #fff;
}

button.secondary {
    background: #e5e7eb;
    color: #111827;
}

.editor-wrapper {
    display: flex;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    overflow: hidden;
}


.line-numbers {
    background: #f1f5f9;
    color: #64748b;
      min-width: 40px;
    padding: 12px 8px;
    text-align: right;
    user-select: none;
    font-family: Consolas, monospace;
    font-size: 14px;
    line-height: 1.4;   /* same */
    overflow: hidden;
}


.line-numbers span {
    display: block;
}

textarea {
    width: 100%;
    height: 70vh;
    padding: 12px;
    border: none;
    resize: none;
    font-family: Consolas, monospace;
    font-size: 14px;
    line-height: 1.4;   /* ðŸ”‘ MUST match line-numbers */
    outline: none;
}



.error {
    color: #dc2626;
    margin-top: 8px;
    font-weight: 600;
}

/* Tree View */
#treeContainer {
    border: 1px solid #d1d5db;
    border-radius: 10px;
    padding: 12px;
    height: 70vh;
    overflow: auto;
    background: #ffffff;
    font-family: Consolas, monospace;
    font-size: 14px;
}

.node {
    margin-left: 16px;
}

.key {
    color: #2563eb;
    font-weight: 600;
}

.value {
    color: #111827;
}

.toggle {
    cursor: pointer;
    margin-right: 6px;
    user-select: none;
}

.collapsed > .children {
    display: none;
}

textarea.error-highlight {
    border-color: #dc2626;
    background: #fef2f2;
}

</style>
</head>

<body data-tool="JSON Pretty Formatter">
<script src="../../assets/js/header.js"></script>
<div class="toolbar">
    <div class="toolbar-left">
        <button onclick="pasteJson()">ðŸ“‹ Paste</button>
        <button onclick="formatJson()">âœ¨ Pretty</button>
        <button onclick="toggleTreeView()">ðŸŒ³ Tree View</button>
        <button onclick="minifyJson()">ðŸ“‰ Minify</button>
        <button onclick="copyJson()">ðŸ“‹ Copy</button>
        <button onclick="clearAll()" class="secondary">ðŸ§¹ Clear</button>
    </div>
    <div class="toolbar-right">
        <div id="error" class="error"></div>
    </div>
    
</div>

<div class="editor-wrapper">
    <div id="lineNumbers" class="line-numbers"></div>
    <textarea id="jsonInput" placeholder="Paste JSON here..."></textarea>
</div>

<div id="treeContainer" style="display:none;"></div>


<script>
const textarea = document.getElementById("jsonInput");
const lineNumbers = document.getElementById("lineNumbers");
const errorBox = document.getElementById("error");
const treeContainer = document.getElementById("treeContainer");

let isTreeView = false;

/* Auto format on typing */
textarea.addEventListener("input", () => {
    updateLineNumbers();
    if (!textarea.value.trim()) {
        errorBox.innerText = "";
        textarea.classList.remove("error-highlight");
        return;
    }

    try {
        JSON.parse(textarea.value);
        errorBox.innerText = "";
        textarea.classList.remove("error-highlight");
   } catch (e) {
    textarea.classList.add("error-highlight");

    let line = null;
    let column = null;

    // Chrome / Edge
    let match = e.message.match(/position (\d+)/);
    if (match) {
        const pos = Number(match[1]);
        ({ line, column } = getLineColumn(textarea.value, pos));
        highlightErrorPosition(pos);
    }

    // Firefox
    match = e.message.match(/line (\d+) column (\d+)/);
    if (match) {
        line = Number(match[1]);
        column = Number(match[2]);
        highlightLineByNumber(line);
    }

    if (line && column) {
        errorBox.innerText = `âŒ Invalid JSON at line ${line}, column ${column}`;
    } else {
        errorBox.innerText = "âŒ Invalid JSON";
    }
}

});

textarea.addEventListener("scroll", () => {
    lineNumbers.scrollTop = textarea.scrollTop;
});



function getLineColumn(text, index) {
    const lines = text.substring(0, index).split("\n");
    return {
        line: lines.length,
        column: lines[lines.length - 1].length + 1
    };
}

function updateLineNumbers() {
    const lines = textarea.value.split("\n").length || 1;
    let html = "";
    for (let i = 1; i <= lines; i++) {
        html += `<span>${i}</span>`;
    }
    lineNumbers.innerHTML = html;
}


function highlightErrorPosition(index) {
    const text = textarea.value;
    let start = index;
    let end = index;

    while (start > 0 && text[start - 1] !== "\n") start--;
    while (end < text.length && text[end] !== "\n") end++;

    // Delay is REQUIRED for textarea selection
    setTimeout(() => {
        textarea.focus();
        textarea.setSelectionRange(start, end);
    }, 0);
}

function highlightLineByNumber(lineNumber) {
    const lines = textarea.value.split("\n");
    let start = 0;

    for (let i = 0; i < lineNumber - 1; i++) {
        start += lines[i].length + 1;
    }

    const end = start + lines[lineNumber - 1].length;

    setTimeout(() => {
        textarea.focus();
        textarea.setSelectionRange(start, end);
    }, 0);
}



/* JSON Helpers */
function tryFormat(pretty) {
    textarea.classList.remove("error-highlight");

    try {
        const parsed = JSON.parse(textarea.value);
        textarea.value = pretty
            ? JSON.stringify(parsed, null, 4)
            : JSON.stringify(parsed);

        errorBox.innerText = "";
        return true;

    } catch (e) {
        textarea.classList.add("error-highlight");

        const match = e.message.match(/position (\d+)/);
        if (match) {
            const pos = Number(match[1]);
            const { line, column } = getLineColumn(textarea.value, pos);

            errorBox.innerText =
                `âŒ Invalid JSON at line ${line}, column ${column}`;

            highlightErrorPosition(pos);
        } else {
            errorBox.innerText = "âŒ Invalid JSON";
        }
        return false;
    }
}



function formatJson() {
    tryFormat(true);
}

function minifyJson() {
    tryFormat(false);
}

function copyJson() {
    if (!textarea.value.trim()) return;
    navigator.clipboard.writeText(textarea.value);
}

function clearAll() {
    textarea.value = "";
    errorBox.innerText = "";
    hideTree();
}

async function pasteJson() {
    try {
        const text = await navigator.clipboard.readText();
        textarea.value = text;
        formatJson();
    } catch {
        errorBox.innerText = "âŒ Clipboard access denied";
    }
}

/* Tree View */
function toggleTreeView() {
    if (!textarea.value.trim()) return;

    if (!isTreeView) {
        showTree();
    } else {
        hideTree();
    }
}

function showTree() {
    try {
        const json = JSON.parse(textarea.value);
        treeContainer.innerHTML = "";
        treeContainer.appendChild(buildTree(json));
        textarea.style.display = "none";
        treeContainer.style.display = "block";
        isTreeView = true;
    } catch {
        errorBox.innerText = "âŒ Invalid JSON";
    }
}

function hideTree() {
    treeContainer.style.display = "none";
    textarea.style.display = "block";
    isTreeView = false;
}

function buildTree(obj) {
    const container = document.createElement("div");

    Object.entries(obj).forEach(([key, value]) => {
        const row = document.createElement("div");
        row.className = "node";

        if (typeof value === "object" && value !== null) {
            const toggle = document.createElement("span");
            toggle.className = "toggle";
            toggle.textContent = "â–¶";

            const label = document.createElement("span");
            label.innerHTML = `<span class="key">${key}</span>:`;

            const children = document.createElement("div");
            children.className = "children";
            children.appendChild(buildTree(value));

            row.append(toggle, label, children);
            row.classList.add("collapsed");

            toggle.onclick = () => {
                row.classList.toggle("collapsed");
                toggle.textContent = row.classList.contains("collapsed") ? "â–¶" : "â–¼";
            };
        } else {
            row.innerHTML = `
                <span class="key">${key}</span>:
                <span class="value">${JSON.stringify(value)}</span>
            `;
        }

        container.appendChild(row);
    });

    return container;
}
updateLineNumbers();

</script>

</body>
</html>
